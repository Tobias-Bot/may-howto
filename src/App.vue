<template>
  <v-app>
    <v-app-bar
      app
      :height="this.toolbarHeight"
      color="#FFEDE7"
      elevation="0"
    >
      <v-toolbar-title>
        <a href="https://vk.com/warmay" hidden ref="linkRef"></a
        ><span class="logoTitle" @click="goToMay">–úŒ±√∫</span
        ><span class="appTitle">—Ö–∞—É–¢—É</span></v-toolbar-title
      >
    </v-app-bar>

    <!-- Sizes your content based upon application components -->
    <v-main>
      <!-- Provides the application the proper gutter -->
      <v-container fluid>
        <v-dialog v-model="dialogSwitch" scrollable>
          <v-card color="#F0D5CE">
            <v-card-title>–ü—Ä–∏–≤–µ—Ç!</v-card-title>
            <v-divider></v-divider>
            <v-card-text
              style="text-align: center; padding: 20px; font-weight: 500; font-size: 14px;"
            >
              –ú—ã –∑–∞–º–µ—Ç–∏–ª–∏, —á—Ç–æ —Ç—ã –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ –ú–∞–π üòî
              <br />
              <br />
              –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–¥–µ—Ä–∂–∏ –Ω–∞—Å –ø–æ–¥–ø–∏—Å–∫–æ–π –Ω–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ, –≤–µ–¥—å —Ç–æ, —á—Ç–æ
              –¥–µ–ª–∞–µ—Ç –ú–∞–π, –≤—Å–µ —ç—Ç–æ –¥–ª—è —Ç–µ–±—è. –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –Ω–∞—à–µ–π —Å–µ–º—å–µ, —á—Ç–æ–±—ã
              —É—á–∏—Ç—å—Å—è –ª—É—á—à–µ —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è –≤ —Å–µ–±–µ –∏ –¥—Ä—É–≥–∏—Ö!
              <br />
              <br />
              ‚ô•
            </v-card-text>
            <v-divider></v-divider>
            <v-card-actions>
              <v-btn
                color="blue darken-1"
                text
                @click="dialogSwitch = !dialogSwitch"
              >
                <v-icon>mdi-close</v-icon>
              </v-btn>
              <v-btn color="#A0847B" text @click="subscribeOnGroup">
                –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è
              </v-btn>
            </v-card-actions>
          </v-card>
        </v-dialog>

        <v-dialog v-model="dialogNotifySwitch" scrollable persistent>
          <v-card color="#F0D5CE">
            <v-card-title>–û–π..</v-card-title>
            <v-divider></v-divider>
            <v-card-text
              style="text-align: center; padding: 20px; font-weight: 500; font-size: 14px;"
            >
              <br />
              –î–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫
              —Å–æ–æ–±—â–µ—Å—Ç–≤–∞–º. –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ú–∞–π —Å–º–æ–≥
              –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–±—è
              <br />
            </v-card-text>
            <v-divider></v-divider>
            <v-card-actions>
              <v-btn color="#A0847B" text @click="getUserData">
                –†–∞–∑—Ä–µ—à–∏—Ç—å
              </v-btn>
            </v-card-actions>
          </v-card>
        </v-dialog>

        <v-dialog v-model="dialogVkDonut" scrollable persistent>
          <v-card color="#F0D5CE">
            <v-card-title>–£–ø—Å..</v-card-title>
            <v-divider></v-divider>
            <v-card-text
              style="text-align: center; padding: 20px; font-weight: 500; font-size: 14px;"
            >
              –î–æ—Å—Ç—É–ø –∫ —ç—Ç–æ–º—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –æ–≥—Ä–∞–Ω–∏—á–µ–Ω üòî
              <br />
              <br />
              –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ —Ç–µ–º, –∫—Ç–æ –æ—Ñ–æ—Ä–º–∏–ª –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ vk
              donut –≤ –ú–∞–π.
              <br />
              <br />
              <div style="text-align: left;">
                <b>–í –ø–æ–¥–ø–∏—Å–∫—É –≤—Ö–æ–¥–∏—Ç:</b>
                <br />
                * –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å –ø—Å–∏—Ö–æ–ª–æ–≥–∞–º–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —á–∞—Ç–µ;<br />
                * –î–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º –ú–∞—è, —Å—Ä–µ–¥–∏ –∫–æ—Ç–æ—Ä—ã—Ö: –∫–∞—Ç–∞–ª–æ–≥ —Å
                –≤–æ–ø—Ä–æ—Å–∞–º–∏ –Ω–∞ –≤—Å–µ —Å–ª—É—á–∞–∏ –∂–∏–∑–Ω–∏ (–ú–∞–π-–∞—Å–∫–ú–∏), –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å —Ç–µ—Å—Ç–∞–º–∏,
                –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç –ª—É—á—à–µ —É–∑–Ω–∞—Ç—å —Å–µ–±—è (–ú–∞–π-—Ç–µ—Å—Ç—ã) –∏ –∫–∞—Ç–∞–ª–æ–≥ —Å
                —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º–∏ –∏ –ø—Ä–∞–∫—Ç–∏–∫–∞–º–∏ (–ú–∞–π-—Ö–∞—É–¢—É)<br />
                * –†–∞–Ω–Ω–∏–π –¥–æ—Å—Ç—É–ø –∫ –Ω–æ–≤—ã–º –ø—É–±–ª–∏–∫–∞—Ü–∏—è–º –ú–∞–π!
                <br />
                <br />
                –°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤—Å–µ–≥–æ 100 —Ä—É–±–ª–µ–π. –ï—Å–ª–∏ —Ç—ã —Ü–µ–Ω–∏—à—å
                –Ω–∞—à —Ç—Ä—É–¥, –ø–æ–¥–ø–∏—Å—ã–≤–∞–π—Å—è –∏ –ø–æ–ª—å–∑—É–π—Å—è —Ç–µ–º, —á—Ç–æ –º—ã –¥–ª—è —Ç–µ–±—è —Å–æ–∑–¥–∞–ª–∏!
                –ò–Ω–∞—á–µ, –∑–∞—á–µ–º —ç—Ç–æ –≤—Å–µ... –ú—ã –ø–æ–º–æ–≥–∞–µ–º —Ç–µ–±–µ, —Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—à—å –Ω–∞—Å.
              </div>
            </v-card-text>
            <v-divider></v-divider>
            <v-card-actions>
              <v-btn color="#A0847B" text>
                –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
              </v-btn>
            </v-card-actions>
          </v-card>
        </v-dialog>

        <v-card>
          <v-tabs-items v-model="tab">
            <v-tab-item>
              <v-card
                flat
                :color="this.colorTheme"
                :height="this.mainScreenHeight"
              >
                <Main />
              </v-card>
            </v-tab-item>
            <v-tab-item>
              <v-card
                flat
                :color="this.colorTheme"
                :height="this.mainScreenHeight"
              >
                <Favorites />
              </v-card>
            </v-tab-item>
          </v-tabs-items>
        </v-card>
      </v-container>
    </v-main>

    <v-footer
      app
      :height="this.footerHeight"
      color="#FFEDE7"
      style="padding: 0px 16px"
    >
      <v-tabs
        v-model="tab"
        :background-color="this.colorTheme"
        slider-color="#FFF4ED"
        color="black"
        grow
        icons-and-text
        slider-size="4"
        style="border-radius: 3px; box-shadow: 0px 1px 5px rgba(0, 0, 0, 0.3);"
      >
        <v-tab>
          <div class="tagTitle">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</div>
          <v-icon>mdi-format-list-bulleted-square</v-icon>
        </v-tab>
        <v-tab>
          <div class="tagTitle">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
          <v-icon>mdi-heart</v-icon>
        </v-tab>
      </v-tabs>
    </v-footer>
  </v-app>
</template>

<script>
import bridge from "@vkontakte/vk-bridge";
import qs from "querystring";

import Main from "./components/Main";
import Favorites from "./components/Favorites";

const group_id = 160404048;

export default {
  name: "App",
  components: {
    Main,
    Favorites,
  },
  data: () => ({
    userId: 0,

    colorTheme: "#F0D0C7",
    toolbarHeight: 55,
    footerHeight: 110,
    mainScreenHeight: 0,
    dialogSwitch: false,
    dialogNotifySwitch: false,
    dialogVkDonut: false,

    tab: null,
  }),
  created() {
    let savedCards = JSON.parse(localStorage.getItem("savedCards"));

    if (savedCards) this.$store.commit("setCards", savedCards);
  },
  mounted() {
    const screenHeight = document.documentElement.scrollHeight;

    this.mainScreenHeight =
      screenHeight - this.toolbarHeight - this.footerHeight;

    // bridge
    //   .send("VKWebAppShowNativeAds", { ad_format: "reward" })
    //   .then((data) => console.log(data.result))
    //   .catch((error) => console.log(error));

    this.getInitialProps();
  },
  methods: {
    subscribeModal() {
      bridge.send("VKWebAppGetUserInfo");
    },
    subscribeOnGroup() {
      bridge.send("VKWebAppJoinGroup", { group_id }).then(() => {
        this.dialogSwitch = false;
      });
    },
    getInitialProps() {
      const str = window.location.search.slice(1);
      const objParams = qs.parse(str);
      this.userId = objParams.vk_user_id;
      let platform = objParams.vk_platform;

      if (platform === "mobile_iphone") {
        this.toolbarHeight = 70;
      }

      this.getUserData();
    },
    getUserData() {
      bridge
        .send("VKWebAppGetAuthToken", {
          app_id: 7957050,
          scope: "groups",
        })
        .then((r) => {
          this.dialogNotifySwitch = false;

          let token = r.access_token;

          bridge
            .send("VKWebAppCallAPIMethod", {
              method: "groups.isMember",
              request_id: "info",
              params: {
                user_id: this.userId,
                group_id,
                v: "5.131",
                access_token: token,
              },
            })
            .then((res) => {
              let isMember = res.response;
              if (!isMember && !this.dialogVkDonut) {
                setTimeout(() => {
                  this.dialogSwitch = true;
                }, 20000);
              }
            });

          bridge
            .send("VKWebAppCallAPIMethod", {
              method: "donut.isDon",
              request_id: "info",
              params: {
                owner_id: group_id,
                v: "5.131",
                access_token: token,
              },
            })
            .then((r) => {
              if (!r.response) {
                setTimeout(() => {
                  this.dialogVkDonut = true;
                }, 6000);
              }
            });
        })
        .catch((e) => {
          if (e.error_data.error_code == 4) {
            this.dialogNotifySwitch = true;
          }
        });
    },
    goToMay() {
      //bridge.send("VKWebAppClose", { status: "success", payload: {} });
      this.$refs.linkRef.click();
    },
  },
};
</script>
